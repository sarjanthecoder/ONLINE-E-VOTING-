<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="/online_e_voting/static/logo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó≥Ô∏è Digital CM Election - Secure E-Voting</title>#safev&secure
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES (Identical to previous, just removed wallet specific styles) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #8b5cf6;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --dark: #0f172a; --dark-light: #1e293b; --text: #f1f5f9;
            --text-muted: #94a3b8; --border: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(30, 41, 59, 0.8);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text); overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }
        main { flex-grow: 1; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; position: relative; z-index: 1; }
        .navbar { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 1rem 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .nav-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 800; cursor: pointer; }
        .logo-icon { font-size: 2rem; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .logo-text { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .nav-links { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .nav-btn { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 0.6rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s ease; }
        .nav-btn:hover { background: var(--primary); border-color: var(--primary); transform: translateY(-2px); }
        .admin-btn { border-color: var(--warning); color: var(--warning); }
        .admin-btn:hover { background: var(--warning); color: var(--dark); }
        
        /* Hero Section */
        .hero-section { padding: 6rem 0; text-align: center; min-height: calc(100vh - 80px); display: flex; align-items: center; justify-content: center; }
        .hero-content { max-width: 900px; margin: 0 auto; }
        .hero-title { font-size: 4rem; font-weight: 800; margin-bottom: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: gradientMove 3s ease infinite; background-size: 200% 200%; }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .hero-subtitle { font-size: 1.5rem; color: var(--primary); margin-bottom: 1.5rem; font-weight: 600; }
        .hero-description { font-size: 1.1rem; color: var(--text-muted); line-height: 1.8; margin-bottom: 3rem; }
        .hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 3rem; }
        .stat-card { background: var(--card-bg); backdrop-filter: blur(10px); padding: 2rem; border-radius: 16px; border: 1px solid var(--border); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3); }
        .stat-number { font-size: 3rem; font-weight: 800; color: var(--primary); margin-bottom: 0.5rem; }
        .stat-label { font-size: 1rem; color: var(--text-muted); }
        .cta-btn { background: var(--gradient); border: none; color: white; padding: 1.2rem 3rem; border-radius: 12px; cursor: pointer; font-size: 1.2rem; font-weight: 700; display: inline-flex; align-items: center; gap: 1rem; transition: all 0.3s ease; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .cta-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6); }
        .arrow { font-size: 1.5rem; transition: transform 0.3s ease; }
        .cta-btn:hover .arrow { transform: translateX(5px); }

        /* Sections */
        .section { padding: 4rem 0; min-height: 100vh; }
        .section-title { font-size: 2.5rem; font-weight: 800; text-align: center; margin-bottom: 3rem; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Verification */
        .verification-card { max-width: 600px; margin: 0 auto 3rem; background: var(--card-bg); backdrop-filter: blur(10px); padding: 3rem; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .card-icon { font-size: 4rem; margin-bottom: 1rem; }
        .verification-card h3 { font-size: 1.8rem; margin-bottom: 1rem; }
        .verification-card p { color: var(--text-muted); margin-bottom: 2rem; }
        .input-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .input-group input { flex: 1; padding: 1rem; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.5); color: var(--text); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; }
        .input-group input:focus { outline: none; border-color: var(--primary); background: rgba(15, 23, 42, 0.8); }
        .verify-btn { background: var(--primary); border: none; color: white; padding: 1rem 2rem; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s ease; }
        .verify-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .privacy-note { font-size: 0.85rem; color: var(--success); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }

        /* Candidates */
        .candidates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .candidate-card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; transition: all 0.3s ease; position: relative; display: flex; flex-direction: column; }
        .candidate-card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4); }
        .candidate-photo { width: 100%; height: 250px; object-fit: cover; border-bottom: 1px solid var(--border); }
        .candidate-info { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .candidate-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .candidate-party { color: var(--text-muted); font-size: 1rem; margin-bottom: 1rem; }
        .vote-btn { width: 100%; background: var(--gradient); border: none; color: white; padding: 1rem; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 700; transition: all 0.3s ease; margin-top: auto; }
        .vote-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
        .vote-btn:disabled { background: var(--dark-light); cursor: not-allowed; opacity: 0.5; }

        /* Forms */
        .register-card { max-width: 700px; margin: 0 auto; background: var(--card-bg); backdrop-filter: blur(10px); padding: 3rem; border-radius: 20px; border: 1px solid var(--border); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); }
        .form-group input, .form-group textarea { width: 100%; padding: 1rem; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.5); color: var(--text); border-radius: 10px; font-size: 1rem; font-family: inherit; transition: all 0.3s ease; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); background: rgba(15, 23, 42, 0.8); }
        .submit-btn { width: 100%; background: var(--gradient); border: none; color: white; padding: 1.2rem; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 700; transition: all 0.3s ease; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }

        /* Results */
        .results-pending { text-align: center; padding: 4rem 2rem; }
        .pending-icon { font-size: 5rem; margin-bottom: 1rem; animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .results-grid { display: grid; gap: 1.5rem; max-width: 900px; margin: 0 auto; }
        .result-card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 20px; padding: 1.5rem 2rem; display: flex; align-items: center; gap: 2rem; transition: all 0.3s ease; }
        .result-card:first-child { border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
        .result-card:hover { border-color: var(--primary); transform: translateX(10px); }
        .result-rank { font-size: 3rem; font-weight: 800; color: var(--primary); min-width: 60px; text-align: center; }
        .result-photo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .result-info { flex: 1; }
        .result-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
        .result-party { color: var(--text-muted); margin-bottom: 0.5rem; }
        .result-votes { display: flex; align-items: center; gap: 0.5rem; }
        .vote-count { font-size: 2rem; font-weight: 800; color: var(--success); }
        .vote-label { color: var(--text-muted); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); backdrop-filter: blur(10px); padding: 3rem; border: 1px solid var(--border); border-radius: 20px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .close { color: var(--text-muted); position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; font-weight: bold; cursor: pointer; transition: color 0.3s ease; }
        .close:hover { color: var(--danger); }
        
        /* Admin */
        .admin-section { margin: 2rem 0; padding: 1.5rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid var(--border); }
        .admin-section h3 { margin-bottom: 1rem; color: var(--primary); }
        .toggle-group { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem; }
        .toggle-group label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .toggle-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .logout-btn { background: var(--danger); border: none; color: white; padding: 1rem 2rem; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; margin-top: 2rem; transition: all 0.3s ease; }
        .logout-btn:hover { background: #dc2626; transform: translateY(-2px); }

        /* Utils */
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--card-bg); backdrop-filter: blur(10px); color: var(--text); padding: 1.5rem 2rem; border-radius: 12px; border-left: 5px solid var(--border); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 3000; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .loading-spinner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        
        .footer { background: rgba(15, 23, 42, 0.95); border-top: 1px solid var(--border); padding: 2rem 0; text-align: center; color: var(--text-muted); position: relative; z-index: 10; margin-top: 4rem; }
        
        @media (max-width: 768px) {
            .hero-title { font-size: 2.5rem; }
            .nav-links { width: 100%; justify-content: center; }
            .candidates-grid { grid-template-columns: 1fr; }
            .result-card { flex-direction: column; text-align: center; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo" onclick="showSection('hero')">
                <span class="logo-icon">üó≥Ô∏è</span>
                <span class="logo-text">CM Election 2025</span>
            </div>
            <div class="nav-links">
                <button class="nav-btn" onclick="showSection('voteSection')">Vote</button>
                <button class="nav-btn" onclick="showSection('registerSection')">Register Candidate</button>
                <button class="nav-btn" onclick="showSection('resultsSection')">Results</button>
                <button class="nav-btn admin-btn" onclick="showAdminLogin()">Admin</button>
            </div>
        </div>
    </nav>

    <main>
        <section id="hero" class="hero-section">
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">Secure Digital Voting</h1>
                    <p class="hero-subtitle">Transparent ‚Ä¢ Encrypted ‚Ä¢ Democratic</p>
                    <p class="hero-description">Cast your vote for the Chief Minister election using our secure digital platform. Every vote is securely recorded in our cloud database, ensuring integrity and speed.</p>
                    <div class="hero-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalVoters">0</div>
                            <div class="stat-label">Registered Voters</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalVotes">0</div>
                            <div class="stat-label">Votes Cast</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCandidates">0</div>
                            <div class="stat-label">Candidates</div>
                        </div>
                    </div>
                    <button class="cta-btn" onclick="showSection('voteSection')">
                        <span>Start Voting Now</span>
                        <span class="arrow">‚Üí</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="voteSection" class="section" style="display: none;">
            <div class="container">
                <h2 class="section-title">Cast Your Vote</h2>
                <div id="aadharVerification" class="verification-card">
                    <div class="card-icon">üîê</div>
                    <h3>Verify Your Identity</h3>
                    <p>Enter your 12-digit Aadhar number for secure verification</p>
                    <div class="input-group">
                        <input type="text" id="aadharInput" placeholder="Enter Aadhar Number" maxlength="12" pattern="[0-9]{12}">
                        <button onclick="verifyAadhar()" class="verify-btn">Verify</button>
                    </div>
                    <p class="privacy-note">üîí Your Aadhar is hashed and securely matched. We ensure one person, one vote.</p>
                </div>
                <div id="candidatesGrid" class="candidates-grid" style="display: none;"></div>
            </div>
        </section>

        <section id="registerSection" class="section" style="display: none;">
            <div class="container">
                <h2 class="section-title">Register as Candidate</h2>
                <div class="register-card">
                    <p style="text-align: center; color: var(--warning); margin-bottom: 2rem;">Note: You must be logged in as an Admin to register a new candidate.</p>
                    <form id="candidateForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="candidateName" required placeholder="Enter candidate name">
                        </div>
                        <div class="form-group">
                            <label>Party Name</label>
                            <input type="text" id="candidateParty" required placeholder="Enter party name">
                        </div>
                        <div class="form-group">
                            <label>Photo URL</label>
                            <input type="url" id="candidatePhoto" required placeholder="https://example.com/photo.jpg">
                        </div>
                        <div class="form-group">
                            <label>Manifesto (Optional)</label>
                            <textarea id="candidateManifesto" rows="4" placeholder="Your vision and promises..."></textarea>
                        </div>
                        <button type="submit" class="submit-btn">Register Candidate</button>
                    </form>
                </div>
            </div>
        </section>

        <section id="resultsSection" class="section" style="display: none;">
            <div class="container">
                <h2 class="section-title">Election Results</h2>
                <div id="resultsContent">
                    </div>
            </div>
        </section>
    </main>

    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <div id="adminLogin">
                <h2>Admin Login</h2>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="adminUsername">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPassword">
                </div>
                <button onclick="adminLogin()" class="submit-btn">Login</button>
            </div>
            <div id="adminPanel" style="display: none;">
                <h2>Admin Panel</h2>
                <div class="admin-section">
                    <h3>Election Settings</h3>
                    <div class="toggle-group">
                        <label><input type="checkbox" id="showResults"><span>Show Results to Public</span></label>
                        <label><input type="checkbox" id="votingEnabled"><span>Enable Voting</span></label>
                    </div>
                    <div class="form-group">
                        <label>Results Reveal Time</label>
                        <input type="datetime-local" id="resultsTime">
                    </div>
                    <button onclick="updateSettings()" class="submit-btn">Update Settings</button>
                </div>
                <div class="admin-section">
                    <h3>Manage Candidates</h3>
                    <div id="adminCandidatesList"></div>
                </div>
                <button onclick="adminLogout()" class="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Secure CM Election. All Rights Reserved.</p>
            <p>A secure digital voting application powered by Firebase.</p>
        </div>
    </footer>

    <div id="toast" class="toast"></div>
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    // --- CONFIGURATION ---
    const API_BASE_URL = window.location.origin;

    // --- GLOBAL STATE ---
    let currentVoterId = sessionStorage.getItem('voter_id');

    // --- DOM ELEMENTS ---
    const sections = {
        hero: document.getElementById('hero'),
        voteSection: document.getElementById('voteSection'),
        registerSection: document.getElementById('registerSection'),
        resultsSection: document.getElementById('resultsSection'),
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        initParticles();
        setupEventListeners();
        fetchStats();
        showSection('hero'); 
        
        if (currentVoterId) {
            document.getElementById('aadharVerification').style.display = 'none';
            fetchCandidatesAndDisplay();
        }
    });
    
    // --- UI MANAGEMENT ---
    function showSection(sectionId) {
        Object.values(sections).forEach(section => section.style.display = 'none');
        if (sections[sectionId]) {
            sections[sectionId].style.display = 'block';
            if(sectionId === 'hero') {
                 sections[sectionId].style.display = 'flex';
            }
        }
        window.scrollTo(0, 0);

        if (sectionId === 'resultsSection') fetchResults();
        if (sectionId === 'voteSection' && currentVoterId) fetchCandidatesAndDisplay();
    }

    function showLoading(isLoading) {
        document.getElementById('loadingSpinner').style.display = isLoading ? 'flex' : 'none';
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
    }

    // --- API INTERACTIONS ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
        };
        if (body) {
            options.body = JSON.stringify(body);
        }
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'An unknown error occurred');
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return await response.json();
            } else {
                return { success: true };
            }
        } catch (error) {
            console.error(`API call to ${endpoint} failed:`, error);
            showToast(error.message, 'error');
            throw error;
        }
    }

    async function fetchStats() {
        try {
            const data = await apiCall('/api/stats');
            document.getElementById('totalVoters').textContent = data.total_voters || 0;
            document.getElementById('totalVotes').textContent = data.total_votes || 0;
            document.getElementById('totalCandidates').textContent = data.total_candidates || 0;
        } catch (error) { }
    }

    async function verifyAadhar() {
        const aadharNo = document.getElementById('aadharInput').value;
        if (!/^\d{12}$/.test(aadharNo)) {
            showToast('Please enter a valid 12-digit Aadhar number.', 'error');
            return;
        }
        showLoading(true);
        try {
            const data = await apiCall('/api/verify-aadhar', 'POST', { aadhar_no: aadharNo });
            currentVoterId = data.voter_id;
            sessionStorage.setItem('voter_id', currentVoterId);
            showToast(data.message, 'success');
            document.getElementById('aadharVerification').style.display = 'none';
            fetchCandidatesAndDisplay();
        } catch (error) {
        } finally {
            showLoading(false);
        }
    }

    async function fetchCandidatesAndDisplay() {
        showLoading(true);
        const grid = document.getElementById('candidatesGrid');
        grid.innerHTML = '';
        try {
            const candidates = await apiCall('/api/candidates');
            if (candidates.length === 0) {
                 grid.innerHTML = '<p style="text-align: center; color: var(--text-muted); grid-column: 1 / -1;">No candidates have been registered yet.</p>';
            } else {
                candidates.forEach(c => {
                    grid.innerHTML += `
                        <div class="candidate-card">
                            <img src="${c.photo_url}" alt="${c.name}" class="candidate-photo">
                            <div class="candidate-info">
                                <h3 class="candidate-name">${c.name}</h3>
                                <p class="candidate-party">${c.party}</p>
                                <button class="vote-btn" onclick="handleVote('${c.id}')">Vote for ${c.name.split(' ')[0]}</button>
                            </div>
                        </div>
                    `;
                });
            }
            grid.style.display = 'grid';
        } catch (error) {
             grid.innerHTML = '<p style="text-align: center; color: var(--danger);">Failed to load candidates.</p>';
        } finally {
            showLoading(false);
        }
    }
    
    async function handleCandidateRegistration(event) {
        event.preventDefault();
        
        const candidateData = {
            name: document.getElementById('candidateName').value,
            party: document.getElementById('candidateParty').value,
            photo_url: document.getElementById('candidatePhoto').value,
            manifesto: document.getElementById('candidateManifesto').value,
        };
        showLoading(true);
        try {
            const data = await apiCall('/api/register-candidate', 'POST', candidateData);
            showToast(data.message, 'success');
            document.getElementById('candidateForm').reset();
            fetchStats();
        } catch (error) {
        } finally {
            showLoading(false);
        }
    }

    async function handleVote(candidateId) {
        if (!currentVoterId) {
            showToast('Please verify your Aadhar first.', 'error');
            return;
        }

        showLoading(true);
        try {
            const voteData = {
                voter_id: currentVoterId,
                candidate_id: candidateId,
            };
            const data = await apiCall('/api/vote', 'POST', voteData);
            showToast(data.message, 'success');
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Voted';
            });
            currentVoterId = null; 
            sessionStorage.removeItem('voter_id');
            fetchStats();
        } catch (error) {
            // Error handled in apiCall
        } finally {
            showLoading(false);
        }
    }

    async function fetchResults() {
        showLoading(true);
        const contentDiv = document.getElementById('resultsContent');
        contentDiv.innerHTML = '';
        try {
            const results = await apiCall('/api/results');
            if (results.length === 0) {
                 contentDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No results to show yet.</p>';
                 return;
            }
            let resultsHtml = '<div class="results-grid">';
            results.forEach((r, index) => {
                resultsHtml += `
                    <div class="result-card">
                        <div class="result-rank">#${index + 1}</div>
                        <img src="${r.photo_url}" alt="${r.name}" class="result-photo">
                        <div class="result-info">
                            <h3 class="result-name">${r.name}</h3>
                            <p class="result-party">${r.party}</p>
                        </div>
                        <div class="result-votes">
                            <span class="vote-count">${r.vote_count.toLocaleString()}</span>
                            <span class="vote-label">Votes</span>
                        </div>
                    </div>
                `;
            });
            resultsHtml += '</div>';
            contentDiv.innerHTML = resultsHtml;
        } catch (error) {
             contentDiv.innerHTML = `
                <div class="results-pending">
                    <div class="pending-icon">‚è≥</div>
                    <h3>Results Not Yet Available</h3>
                    <p>${error.message}</p>
                </div>
             `;
        } finally {
            showLoading(false);
        }
    }

    // --- ADMIN PANEL ---
    function showAdminLogin() {
        document.getElementById('adminModal').style.display = 'flex';
        document.getElementById('adminLogin').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
    }

    function closeAdminModal() {
        document.getElementById('adminModal').style.display = 'none';
    }

    async function adminLogin() {
        const username = document.getElementById('adminUsername').value;
        const password = document.getElementById('adminPassword').value;
        showLoading(true);
        try {
            await apiCall('/api/admin/login', 'POST', { username, password });
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminPanelData();
        } catch (error) {
        } finally {
            showLoading(false);
        }
    }

    async function adminLogout() {
        await apiCall('/api/admin/logout', 'POST');
        showToast('Logged out successfully.', 'success');
        closeAdminModal();
    }

    function loadAdminPanelData() {
        fetchAdminSettings();
        fetchAdminCandidates();
    }

    async function fetchAdminSettings() {
        try {
            const settings = await apiCall('/api/admin/settings');
            document.getElementById('showResults').checked = settings.show_results;
            document.getElementById('votingEnabled').checked = settings.voting_enabled;
            if (settings.results_reveal_time) {
                document.getElementById('resultsTime').value = settings.results_reveal_time.slice(0, 16);
            }
        } catch(e){}
    }
    
    async function fetchAdminCandidates() {
        const listDiv = document.getElementById('adminCandidatesList');
        listDiv.innerHTML = 'Loading...';
        try {
            const candidates = await apiCall('/api/candidates');
            if(candidates.length === 0) {
                listDiv.innerHTML = '<p>No candidates found.</p>';
                return;
            }
            listDiv.innerHTML = '';
            candidates.forEach(c => {
                listDiv.innerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                        <span>${c.name} - ${c.party}</span>
                        <button onclick="deleteCandidate('${c.id}')" style="background: var(--danger); border: none; color: white; padding: 0.3rem 0.7rem; border-radius: 5px; cursor: pointer;">Delete</button>
                    </div>
                `;
            });
        } catch(e) {
            listDiv.innerHTML = '<p style="color: var(--danger)">Could not load candidates.</p>';
        }
    }

    async function updateSettings() {
        const settings = {
            show_results: document.getElementById('showResults').checked,
            voting_enabled: document.getElementById('votingEnabled').checked,
            results_reveal_time: document.getElementById('resultsTime').value || null,
        };
        await apiCall('/api/admin/settings', 'POST', settings);
        showToast('Settings updated!', 'success');
    }
    
    async function deleteCandidate(candidateId) {
        if (confirm('Are you sure you want to delete this candidate? This action cannot be undone.')) {
            await apiCall(`/api/admin/delete-candidate/${candidateId}`, 'DELETE');
            showToast('Candidate deleted.', 'success');
            fetchAdminCandidates();
            fetchStats();
        }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.getElementById('candidateForm').addEventListener('submit', handleCandidateRegistration);
    }
    
    // --- UTILITIES ---
    function initParticles() {
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#ffffff" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: true },
                size: { value: 3, random: true },
                line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.4, width: 1 },
                move: { enable: true, speed: 2, direction: "none", random: false, straight: false, out_mode: "out" }
            },
            interactivity: {
                detect_on: "canvas",
                events: { onhover: { enable: true, mode: "repulse" }, onclick: { enable: true, mode: "push" }, resize: true },
                modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
            },
            retina_detect: true
        });
    }
    </script>
</body>

</html>
